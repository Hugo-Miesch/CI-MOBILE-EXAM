name: CI Main + Releases

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
      - "rc*"

jobs:
  main:
    runs-on: ubuntu-latest

    env:
      SIGNING_ENABLED: "true"
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      GOOGLE_PLAY_JSON: ${{ secrets.GOOGLE_PLAY_JSON }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: CIMOBILEEXAM

      - name: Restore keystore
        if: ${{ env.SIGNING_ENABLED == 'true' }}
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > $GITHUB_WORKSPACE/release.jks
          echo "KEYSTORE_PATH=$GITHUB_WORKSPACE/release.jks" >> $GITHUB_ENV

      - name: Detect previous tag
        id: prevtag
        run: |
          PREV=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "prev=$PREV" >> $GITHUB_OUTPUT

      - name: Build release + changelog + maybe deploy
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        working-directory: CIMOBILEEXAM
        run: bundle exec fastlane android ci_main_release from:${{ steps.prevtag.outputs.prev }}

      - name: Build release only (push main without tag)
        if: ${{ github.ref == 'refs/heads/main' }}
        working-directory: CIMOBILEEXAM
        run: |
          bundle exec fastlane android unit_tests
          bundle exec fastlane android build_release
          bundle exec fastlane android generate_changelog from:${{ steps.prevtag.outputs.prev }}

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: CIMOBILEEXAM/app/build/outputs/bundle/release/*.aab

      - name: Upload mapping.txt
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: mapping
          path: CIMOBILEEXAM/app/build/outputs/mapping/release/mapping.txt

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CIMOBILEEXAM/fastlane/CHANGELOG.md
